<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªá Th·ªëng Gi√°m S√°t ƒêa L·ªõp</title>
  <link rel="icon" href="AI Smart Monitor.ico" type="image/x-icon">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #ddd; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2e7d32; padding-bottom: 15px; margin-bottom: 20px; }
   
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .card { background: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    h2 { margin-top: 0; color: #4caf50; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px;}

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; border-bottom: 1px solid #333; text-align: left; font-size: 0.95rem; }
    th { color: #888; font-weight: 600; }
    tr:hover { background-color: #252525; }

    .risk-bar-bg { background: #333; height: 6px; border-radius: 3px; width: 100%; margin-top: 5px; }
    .risk-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #4caf50, #f44336); }

    select, input[type="date"] { 
            background: #333; 
            color: white; 
            padding: 8px 12px; 
            border: 1px solid #4caf50; 
            border-radius: 4px; 
            font-size: 1rem; 
        }
   
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
    .bg-red { background: #c62828; color: white; }
    .bg-orange { background: #ef6c00; color: white; }
    .bg-blue { background: #1565c0; color: white; }
    .bg-purple { background: #6a1b9a; color: white; }
  </style>
</head>
<body>

  <div class="header">
    <h1>üõ°Ô∏è MONITOR CENTER</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
            
            <label>Ch·∫ø ƒë·ªô:</label>
            <select id="modeSelect" onchange="loadData()">
                <option value="epd_full">Qu√©t C·∫£m x√∫c v√† T∆∞ th·∫ø</option>
                <option value="epd_distraction">Ch·ªëng m·∫•t t·∫≠p trung</option>
            </select>
                  <label>L·ªõp:</label>
          <select id="classSelect" onchange="loadData()">
            <option value="L·ªõp 12A1">L·ªõp 12A1</option>
            <option value="L·ªõp 12A2">L·ªõp 12A2</option>
            <option value="L·ªõp 12A4">L·ªõp 12A4</option>
            <option value="L·ªõp 12A5">L·ªõp 12A5</option>
          </select>
         
                <label>Ng√†y:</label>
                <input type="date" id="dateSelect" onchange="loadData()">

          <a href="/logout" style="background: #c62828; color: white; padding: 8px 15px; text-decoration: none; border-radius: 4px; font-size: 0.9rem; margin-left: 20px;">
            ƒêƒÉng Xu·∫•t
          </a>
    </div>
  </div>

  <div class="dashboard-grid">
   
    <div class="card">
      <h2>üìú Nh·∫≠t K√Ω Vi Ph·∫°m Chi Ti·∫øt</h2>
      <table>
        <thead>
          <tr>
            <th width="15%">H·ªçc Sinh</th>
            <th width="25%">V·∫•n ƒë·ªÅ</th>
            <th width="20%">Ng√†y</th> <th width="25%">Khung Gi·ªù</th> <th width="15%">Th·ªùi l∆∞·ª£ng</th>
          </tr>
        </thead>
        <tbody id="log-table"></tbody>
      </table>
    </div>

    <div class="card">
      <h2>‚ö†Ô∏è B·∫£ng X·∫øp H·∫°ng Nguy C∆°</h2>
      <small style="color: #777">D·ª±a tr√™n t·ªïng th·ªùi gian t√≠ch l≈©y</small>
      <table style="margin-top: 15px;">
        <thead>
          <tr><th>H·∫°ng</th><th>H·ªçc Sinh</th><th>ƒêi·ªÉm R·ªßi Ro</th></tr>
        </thead>
        <tbody id="risk-table"></tbody>
      </table>
    </div>
  </div>

  <script>
        // H√†m l·∫•y ng√†y h√¥m nay d∆∞·ªõi ƒë·ªãnh d·∫°ng YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh l√† ng√†y h√¥m nay khi trang t·∫£i
        document.getElementById('dateSelect').value = getTodayDate();
        

    function getBadge(issue) {
      if(issue.includes("Ng·ªß")) return `<span class="badge bg-red">${issue}</span>`;
      if(issue.includes("M·ªát") || issue.includes("M·∫•t")) return `<span class="badge bg-orange">${issue}</span>`;
      if(issue.includes("Bu·ªìn")) return `<span class="badge bg-blue">${issue}</span>`;
      return `<span class="badge bg-purple">${issue}</span>`;
    }

    async function loadData() {
            // B∆Ø·ªöC 1: L·∫§Y THAM S·ªê T·ª™ C√ÅC CONTROL
            const currentMode = document.getElementById("modeSelect").value; // L·∫•y ch·∫ø ƒë·ªô qu√©t
      const currentClass = document.getElementById("classSelect").value;
            const selectedDate = document.getElementById("dateSelect").value;
            const dateToFetch = selectedDate || getTodayDate();
     
      // 1. L·∫•y logs - URL API ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi tham s·ªë mode
      // URL m·∫´u: /api/get_logs/epd_full/L·ªõp 12A1/2023-10-26
      const logRes = await fetch(`/api/get_logs/${currentMode}/${currentClass}/${dateToFetch}`);
      const logs = await logRes.json();
      const logTable = document.getElementById("log-table");
     
      logTable.innerHTML = logs.map(l => {
                const displayDate = l.date ? l.date.split('T')[0] : dateToFetch;
                return `
        <tr>
          <td style="color:#4caf50; font-weight:bold">HS-${l.zone_id}</td>
          <td>${getBadge(l.issue_type)}</td>
          <td style="color: #aaa">${displayDate}</td> 
                    <td>${l.start_time} - ${l.end_time}</td> 
                    <td>${l.duration_seconds}s</td>
        </tr>
      `
            }).join('');

      // 2. L·∫•y ranking - URL API ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi tham s·ªë mode
      // URL m·∫´u: /api/get_risk_ranking/epd_full/L·ªõp 12A1/2023-10-26
      const riskRes = await fetch(`/api/get_risk_ranking/${currentMode}/${currentClass}/${dateToFetch}`);
      const ranking = await riskRes.json();
      const riskTable = document.getElementById("risk-table");
     
      const maxScore = ranking.length > 0 ? ranking[0].score : 1;

      riskTable.innerHTML = ranking.map((r, index) => {
        const percent = (r.score / maxScore) * 100;
        let color = "#4caf50";
        if(index === 0) color = "#d32f2f";
        else if(index < 3) color = "#f57c00";

        return `
        <tr>
          <td>#${index + 1}</td>
          <td style="font-weight:bold; color:${color}">HS-${r.id}</td>
          <td>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem">
              <span>${r.score} ƒëi·ªÉm</span>
            </div>
            <div class="risk-bar-bg">
              <div class="risk-bar-fill" style="width: ${percent}%; background: ${color}"></div>
            </div>
          </td>
        </tr>
        `;
      }).join('');
    }

    setInterval(loadData, 2000);
    loadData();
  </script>
 
</body>
</html>
